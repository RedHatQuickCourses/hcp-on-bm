<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Optional: Configure Virtual BMC Services on the Bare Metal Host :: Hosted Control Planes on a Single Bare Metal Node</title>
    <link rel="prev" href="../chapter6/index.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Hosted Control Planes on a Single Bare Metal Node</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/hcp-on-bm/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="hcp-on-bm" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Hosted Control Planes on a Single Bare Metal Node</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter0/index.html">Introduction to OpenShift HCP and the PoC Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter1/index.html">Deploy the Bare Metal Node</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter2/index.html">Prepare the Bare Metal Node</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter3/index.html">Setup the Hub Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter4/index.html">Add Managed Hosts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter5/index.html">Create and Access a Hosted Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter7/index.html">Explore the Deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter6/index.html">Closing Words</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="index.html">Optional: Configure Virtual BMC Services on the Bare Metal Host</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Hosted Control Planes on a Single Bare Metal Node</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Hosted Control Planes on a Single Bare Metal Node</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Hosted Control Planes on a Single Bare Metal Node</a></li>
    <li><a href="index.html">Optional: Configure Virtual BMC Services on the Bare Metal Host</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Optional: Configure Virtual BMC Services on the Bare Metal Host</h1>
<div class="paragraph">
<p>This lab shows how to configure the bare metal host to provide a virtual Baseboard Management Controller (vBMC) and how to add such hosts to the ACM inventory using BMC, so that you can demonstrate the usage of managed servers as part of a hosted cluster.</p>
</div>
<div class="paragraph">
<p>The <a href="https://docs.openstack.org/virtualbmc/latest/" target="_blank" rel="noopener">virtualbmc</a> open source software enables managing libvirt VMs as if they were bare metal machines with IPMI controllers or similar management hardware. It enables testing of IPMI clients, such as the <code>ipmitool</code> command, and services such as <a href="https://github.com/openstack/ironic">OpenStack Ironic</a> and the <a href="https://github.com/openshift/cluster-baremetal-operator">OpenShift Cluster Bare Metal operator</a>.</p>
</div>
<div class="paragraph">
<p><em>Watch the following video and then follow the instructions in this section to perform the lab.</em></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you have issues watching the video embedded in this page, watch it directly on the <a href="https://videos.learning.redhat.com/media/hcp-on-bm-intro/1_gyapthnx" target="_blank" rel="noopener">Red Hat media space</a>, which requires the Red Hat VPN and an employee log in.
</td>
</tr>
</table>
</div>
<iframe type="text/javascript" src='https://cdnapisec.kaltura.com/p/2032581/embedPlaykitJs/uiconf_id/49478072?iframeembed=true&entry_id=1_8n546joe' style="width: 768px; height: 432px" allowfullscreen webkitallowfullscreen mozAllowFullScreen allow="autoplay *; fullscreen *; encrypted-media *" frameborder="0"></iframe>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install vBMC, if not already installed by the playbooks from the previous lab.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># pip install virtualbmc</code></pre>
</div>
</div>
</li>
<li>
<p>Create a Systemctl service unit.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># vi /etc/systemd/system/vbmcd.service</code></pre>
</div>
</div>
</li>
<li>
<p>Copy and paste the following to the new unit.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[Install]
WantedBy = multi-user.target

[Service]
BlockIOAccounting = True
CPUAccounting = True
ExecReload = /bin/kill -HUP $MAINPID
ExecStart = /usr/local/bin/vbmcd --foreground
Group = root
MemoryAccounting = True
PrivateDevices = False
PrivateNetwork = False
PrivateTmp = False
PrivateUsers = False
Restart = on-failure
RestartSec = 2
Slice = vbmc.slice
TasksAccounting = True
TimeoutSec = 120
Type = simple
User = root

[Unit]
After = libvirtd.service
After = syslog.target
After = network.target
Description = vbmc service</code></pre>
</div>
</div>
</li>
<li>
<p>Enable the service unit.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># systemctl daemon-reload
# systemctl enable vbmcd.service
# systemctl start vbmcd.service
# systemctl status vbmcd.service</code></pre>
</div>
</div>
</li>
<li>
<p>Create, but DO NOT boot, a VM to be managed by vBMC. Its settings should be similar to a VM that would boot using PXE.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Using the Virtual Machine Manager (<code>virt-manager</code>) utility, create a new VM named <code>c1worker3</code>, selecting <strong>Manual install</strong>. Configure the VM with at least 8GiB memory, 4vCPUS, and 128GB of disk. Be sure you check <strong>Customize configuration before install</strong> on Step 5 of 5.</p>
<div class="imageblock">
<div class="content">
<img src="_images/fig-5-1.jpg" alt="fig 5 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/fig-5-2.jpg" alt="fig 5 2">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/fig-5-3.jpg" alt="fig 5 3">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/fig-5-4.jpg" alt="fig 5 4">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/fig-5-5.jpg" alt="fig 5 5">
</div>
</div>
</li>
<li>
<p>Set the NIC of the VM to a MAC address configured on the libvirt default network.</p>
<div class="imageblock">
<div class="content">
<img src="_images/fig-5-6.jpg" alt="fig 5 6">
</div>
</div>
</li>
<li>
<p>Select <strong>Boot Options</strong>, keep the disk as the first boot device and add the NIC as the second boot device in the order. Then click <strong>Begin Installation</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/fig-5-7.jpg" alt="fig 5 7">
</div>
</div>
<div class="paragraph">
<p>This way, the VM boots from the NIC when the disk is empty, and boots from disk once CoreOS is installed. If you start with the NIC as first boot options, you must manually change the order later, after PXE boot, to boot from disk.</p>
</div>
</li>
<li>
<p>DO NOT let your new VM boot. Right after creating it, <strong>Virtual Machine &gt; Shutdown &gt; Force off</strong> to stop your VM. It  will later be started by BMC.</p>
<div class="imageblock">
<div class="content">
<img src="_images/fig-5-8.jpg" alt="fig 5 8">
</div>
</div>
</li>
<li>
<p>Alternatively, use the following commands to create the VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># qemu-img create -f qcow2 -o preallocation=metadata /var/lib/libvirt/images/c1worker3.qcow2 120G
# virt-install --name c1worker3 \
--ram 8192 --vcpus 4 --os-variant rhel9.5 \
--disk path=/var/lib/libvirt/images/c1worker3.qcow2,device=disk,bus=virtio,format=qcow2 \
--network network:default,mac=52:54:00:e2:54:43 \
--noautoconsole --vnc --cpu host-passthrough \
--boot hd,network --print-xml &gt; c1worker3.xml
# virsh define c1worker3.xml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Add an ip address for vBMC to listen. It requires a unique IP address for each VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># ip addr add 192.168.122.71/32 dev virbr0</code></pre>
</div>
</div>
</li>
<li>
<p>Associate the IP address with an your VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># /usr/local/bin/vbmc add c1worker3 --address 192.168.122.71 --username admin --password redhat</code></pre>
</div>
</div>
</li>
<li>
<p>Start the vbmc for that VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># /usr/local/bin/vbmc start c1worker3</code></pre>
</div>
</div>
</li>
<li>
<p>Make sure that service is running for that vm.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># /usr/local/bin/vbmc list
+-------------+---------+----------------+------+
| Domain name | Status  | Address        | Port |
+-------------+---------+----------------+------+
| c1worker3   | running | 192.168.122.71 |  623 |
+-------------+---------+----------------+------+</code></pre>
</div>
</div>
</li>
<li>
<p>You may have to manually reboot the BMC managed node after correcting the boot order to boot from disk manually.</p>
</li>
<li>
<p>Create a provisioning resource using the following manifest.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">apiVersion: metal3.io/v1alpha1
kind: Provisioning
metadata:
  name: provisioning-configuration
spec:
  provisioningNetwork: "Disabled"
  watchAllNamespaces: true</code></pre>
</div>
</div>
</li>
<li>
<p>Add a host using BMC.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Infrastructure &gt; Host Inventory</strong>, click on <strong>Add hosts</strong> and select <strong>With BMC form</strong> to configure BMC.</p>
</li>
<li>
<p>Fill in Name, Hostname, Baseboard Management Controller Address, Boot NIC MAC Address, username and password. Click <strong>Create</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/fig-12.jpg" alt="fig 12">
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Wait as vBMC boots the node and ACM adds it to the host inventory.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The node first will transition to "Registering" then to “Provisioning”.</p>
</li>
<li>
<p>The node will get automatically started by vbmc, boot to pxe and will become automatically available in host inventory. There is no need to approve a node created via vbmc.</p>
</li>
<li>
<p>The node is now ready to be added to any new cluster or to scale out existing clusters.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<nav class="pagination">
  <span class="prev"><a href="../chapter6/index.html">Closing Words</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
