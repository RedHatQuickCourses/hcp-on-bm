<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Prepare the Bare Metal Node :: Hosted Control Planes on a Single BareMetal Node</title>
    <link rel="prev" href="../chapter1/index.html">
    <link rel="next" href="../chapter3/index.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Hosted Control Planes on a Single BareMetal Node</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/hcp-on-bm/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="hcp-on-bm" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Hosted Control Planes on a Single BareMetal Node</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter0/index.html">Introduction to OpenShift HCP and the PoC Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter1/index.html">Deploy the Bare Metal Node</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="index.html">Prepare the Bare Metal Node</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter3/index.html">Setup the Hub Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter4/index.html">Add Managed Hosts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter5/index.html">Create and Access a Hosted Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../chapter6/index.html">Build from Here</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendix/index.html">Optional: Configure Virtual BMC Services on the Bare Metal Host</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Hosted Control Planes on a Single BareMetal Node</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Hosted Control Planes on a Single BareMetal Node</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Hosted Control Planes on a Single BareMetal Node</a></li>
    <li><a href="index.html">Prepare the Bare Metal Node</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Prepare the Bare Metal Node</h1>
<div class="paragraph">
<p>This lab shows how configure the bare metal host with virtual networking and a helper services VM, by using an Ansible playbook provided on a git repository. It also configures the bare metal host for graphical access, so you can run a web browser and virt-manager on the following labs.</p>
</div>
<div class="paragraph">
<p><em>Watch the following video and then follow the instructions in this section to perform the lab.</em></p>
</div>
<iframe id="kmsembed-1_rtsirpp6" width="768" height="432" src="https://videos.learning.redhat.com/embed/secure/iframe/entryId/1_rtsirpp6/uiConfId/44630491/st/0" class="kmsembed" allowfullscreen webkitallowfullscreen mozAllowFullScreen allow="autoplay *; fullscreen *; encrypted-media *" referrerPolicy="no-referrer-when-downgrade" sandbox="allow-downloads allow-forms allow-same-origin allow-scripts allow-top-navigation allow-pointer-lock allow-popups allow-modals allow-orientation-lock allow-popups-to-escape-sandbox allow-presentation allow-top-navigation-by-user-activation" frameborder="0" title="hcp-on-bm-bm-host"></iframe>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Review the architecture of the proof-of-concept for HCP on bare metal nodes .</p>
<div class="imageblock">
<div class="content">
<img src="_images/s3-fig-1.png" alt="s3 fig 1">
</div>
</div>
<div class="paragraph">
<p>For now, you will configure just the libvirt network and the helper services VM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is only one helper VM, which runs all of the DNS, HAProxy, and BOOTP daemons.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Once the instance is up and running, SSH to the node using the private key downloaded in the previous lab.</p>
<div class="imageblock">
<div class="content">
<img src="_images/s3-fig-2.jpg" alt="s3 fig 2">
</div>
</div>
</li>
<li>
<p>The public IP of the instance can be obtained from the AWS console after clicking on the instance.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ ssh -i <em>&lt;path to the private key&gt;</em>  ec2-user@<em>&lt;public ip&gt;</em></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your SSH client supports it, enable keep alive so the connection doesn&#8217;t terminate during long-running Ansible playbooks, killing the Ansible runner and letting your host only partially configured.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ ssh -o "ServerAliveInterval 30" -o "ServerAliveCountMax 120" -i <em>&lt;path to the private key&gt;</em> ec2-user@<em>&lt;public ip&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Install Ansible Core and other supporting packages.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ sudo -i
# dnf install -y tmux waypipe
# dnf groupinstall -y "Server with GUI"
# dnf install -y ansible-core
# ansible-galaxy collection install community.libvirt
# ansible-galaxy collection install community.crypto</code></pre>
</div>
</div>
</li>
<li>
<p>Configure remote graphical access, using one of the two alternatives:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If your workstation runs Fedora Linux or any other Linux distribution with Wayland, you can use the <code>waypipe</code> command in front of the <code>ssh</code> command that connects to your EC2 instance, and start a web browser or any other GUI application from the shell.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ waypipe ssh -o "ServerAliveInterval 30" -o "ServerAliveCountMax 120" -i <em>&lt;path to the private key&gt;</em> ec2-user@<em>&lt;public ip&gt;</em>
$ firefox &amp;</code></pre>
</div>
</div>
</li>
<li>
<p>If your workstation cannot not run Wayland, for example MacOS laptops, you can setup VNC access.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We are NOT providing instructions for installing and configuring VNC viewers on desktop operating systems.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># dnf install -y tigervnc tigervnc-server
# echo ":99=vncuser" &gt;&gt; /etc/tigervnc/vncserver.users
# systemctl enable vncserver@:99 --now
# useradd vncuser
# su - vncuser
$ vncpasswd   # set a strong password
Would you like to enter a view-only password (y/n)? n
$ exit</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the public ip of the bare metal node on port 5999, using a VNC viewer, to get its graphical console and open a web browser.</p>
</li>
<li>
<p>The following instructions will ask you to access the Red Hat customer portal and Red Hat Hybrid Cloud Console. You can do it directly from the bare metal instance, using the graphical access you just configured, or access those sites from your workstation and them copy files to the EC2 instance.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Download latest <code>rhel-9.5-x86_64-kvm.qcow2</code> cloud image (<strong>Red Hat Enterprise Linux 9.5 KVM Guest Image</strong>) from the <a href="https://access.redhat.com/downloads">customer portal</a> and copy to the bare metal node.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The instructions are expected to work with different versions of RHEL but were tested with RHEL 9.5.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Clone the git repository and move the RHEL Image to the correct directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># git clone https://github.com/RedHatQuickCourses/hcp-on-bm-playbooks.git
# cd hcp-on-bm-playbooks
# cp ~vncuser/Downloads/rhel-9.6-x86_64-kvm.qcow2 roles/setup-bm-host/files/</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We use a fork of the <a href="https://github.com/v2pkthakur/hcp-on-bm.git" target="_blank" rel="noopener">original repository</a> to ensure the reproducibility of the instructions here. The original repository may include contributions and improvements, made after creation of this course, which may interest you.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Explore the inventory and variables and update where required.</p>
<div class="paragraph">
<p>For example, if you got a newer version of RHEL9 cloud image instead of RHEL9.5, please update the <code>rhel9_kvm_image</code> variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ vi vars.yaml
...
rhel9_kvm_image: rhel-9.6-x86_64-kvm.qcow2
...</code></pre>
</div>
</div>
</li>
<li>
<p>Login on the <a href="https://console.redhat.com">Red Hat Hybrid Cloud Console</a> and get your organization ID, which can be obtained by clicking your name on top right.</p>
<div class="imageblock">
<div class="content">
<img src="_images/s3-fig-3.jpg" alt="s3 fig 3">
</div>
</div>
</li>
<li>
<p>Create an activation key from the cloud console by entering its <a href="https://console.redhat.com/insights/connector/activation-keys">Insights pages</a> and note down the name of the activation key.</p>
<div class="paragraph">
<p>Use the details from the screenshot to fill the activation key details. Make sure that you name it appropriately.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/s3-fig-4.jpg" alt="s3 fig 4">
</div>
</div>
</li>
<li>
<p>Copy your OpenShift pull secret from the cloud console by entering its <a href="https://console.redhat.com/openshift/install/pull-secret">OpenShift install page</a>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/s3-fig-5.jpg" alt="s3 fig 5">
</div>
</div>
</li>
<li>
<p>Configure Ansible Vault to store your organization ID, activation keys, and OpenShift pull secret.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># ansible-vault create vault.yaml
New Vault password:
Confirm New Vault password:
org_id: <em>XXXX</em>
activation_key: <em>YYYYY</em>
pull_secret: '<em>ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ</em>'</code></pre>
</div>
</div>
</li>
<li>
<p>Set up the bare metal node by running the Ansible playbook.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ ansible-playbook -i inventory/hosts setup_bm_host.yaml --ask-vault-pass</code></pre>
</div>
</div>
</li>
<li>
<p>Review key configuration settings that will affect our hosted clusters in the final activity.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>You should have a single libvirt VM named <code>helper</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># virsh list --all
 Id   Name     State
------------------------
 1    helper   running</code></pre>
</div>
</div>
</li>
<li>
<p>Review the libvirt default network settings. It provides fixed IP addresses, based on MAC addresses, for six hosts, anticipating two different hosted clusters with three nodes each. You can add more if you need.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># virsh net-dumpxml default
&lt;network connections='8'&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;467059b1-29f1-4bfc-bb9a-1b5ae26d244c&lt;/uuid&gt;
  &lt;forward mode='nat'&gt;
    &lt;nat&gt;
      &lt;port start='1024' end='65535'/&gt;
    &lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge name='virbr0' stp='on' delay='0'/&gt;
  &lt;mac address='52:54:00:c7:82:0c'/&gt;
  &lt;dns&gt;
    &lt;forwarder domain='hub.mylab.com' addr='192.168.122.21'/&gt;
    &lt;forwarder domain='hcp-cluster1.mylab.com' addr='192.168.122.21'/&gt;
    &lt;forwarder domain='hcp-cluster2.mylab.com' addr='192.168.122.21'/&gt;
    &lt;forwarder domain='122.168.192.in-addr.arpa' addr='192.168.122.21'/&gt;
  &lt;/dns&gt;
  &lt;ip address='192.168.122.1' netmask='255.255.255.0'&gt;
    &lt;dhcp&gt;
      &lt;host mac='52:54:00:e2:54:21' name='helper_server.hub.mylab.com' ip='192.168.122.21'/&gt;
      &lt;host mac='52:54:00:e2:54:30' name='bootstrap.hub.mylab.com' ip='192.168.122.30'/&gt;
      &lt;host mac='52:54:00:e2:54:31' name='master1.hub.mylab.com' ip='192.168.122.31'/&gt;
      &lt;host mac='52:54:00:e2:54:32' name='master2.hub.mylab.com' ip='192.168.122.32'/&gt;
      &lt;host mac='52:54:00:e2:54:33' name='master3.hub.mylab.com' ip='192.168.122.33'/&gt;
      &lt;host mac='52:54:00:e2:54:34' name='worker1.hub.mylab.com' ip='192.168.122.34'/&gt;
      &lt;host mac='52:54:00:e2:54:35' name='worker2.hub.mylab.com' ip='192.168.122.35'/&gt;
      &lt;host mac='52:54:00:e2:54:36' name='worker3.hub.mylab.com' ip='192.168.122.36'/&gt;
      &lt;host mac='52:54:00:e2:54:39' name='hublb.hub.mylab.com' ip='192.168.122.39'/&gt;
      &lt;host mac='52:54:00:e2:54:41' name='c1worker1.hub.mylab.com' ip='192.168.122.41'/&gt;
      &lt;host mac='52:54:00:e2:54:42' name='c1worker2.hub.mylab.com' ip='192.168.122.42'/&gt;
      &lt;host mac='52:54:00:e2:54:43' name='c1worker3.hub.mylab.com' ip='192.168.122.43'/&gt;
      &lt;host mac='52:54:00:e2:54:49' name='c1lb.hub.mylab.com' ip='192.168.122.49'/&gt;
      &lt;host mac='52:54:00:e2:54:51' name='c2worker1.hub.mylab.com' ip='192.168.122.51'/&gt;
      &lt;host mac='52:54:00:e2:54:52' name='c2worker2.hub.mylab.com' ip='192.168.122.52'/&gt;
      &lt;host mac='52:54:00:e2:54:53' name='c2worker3.hub.mylab.com' ip='192.168.122.53'/&gt;
      &lt;host mac='52:54:00:e2:54:59' name='c2lb.hub.mylab.com' ip='192.168.122.59'/&gt;
      &lt;host mac='52:54:00:e2:54:71' name='c2vbmc.hub.mylab.com' ip='192.168.122.71'/&gt;
      &lt;host mac='52:54:00:e2:54:81' name='aap.hub.mylab.com' ip='192.168.122.81'/&gt;
      &lt;bootp file='pxelinux.0' server='192.168.122.21'/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>It also provide for three load balancer IPs, one for the hub cluster, and two for hosted clusters. If you need more, you also need to change the HAProxy settings on the helper VM.</p>
</li>
<li>
<p>Finally, it configures Libvirt&#8217;s DNS server to forward queries for the domains of the hub and two hosted clusters.</p>
</li>
<li>
<p>Open a SSH session to the helper VM and inspect open network ports. Notice the <code>haproxy</code> and <code>named</code> daemons running, and also that Systemd will start an TFTP server when there&#8217;s UDP traffic to it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># ssh -i ~/.ssh/lab_rsa 192.168.122.21
# netstat -lntp
# systemctl status tftp.socket
# exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Allow access to managing libvirt system VMs for your GUI user.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add either the <code>ec2-user</code> user (if using waypipe) or the <code>vncuser</code> user (if using a VNC viewer) to the <code>libvirt</code> group.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># usermod -aG libvirt vncuser
# usermod -aG libvirt ec2-user</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
We recommend against enabling a VNC Viewer for the ec2-user, which is also allowed unrestricted Sudo, because the VNC protocol security is weaker than SSH.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If using a VNC viewer, you must stop and restart your VNC desktop.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># systemctl stop vncserver@:99
# systemctl start vncserver@:99</code></pre>
</div>
</div>
</li>
<li>
<p>If using waypipe, you must close and reconnect your SSH session.</p>
</li>
<li>
<p>In either case, check that the <code>libvirt</code> group is on the environment of your GUI user.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ id
uid=1000(ec2-user) gid=1000(ec2-user) groups=1000(ec2-user),4(adm),190(systemd-journal),984(libvirt) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<nav class="pagination">
  <span class="prev"><a href="../chapter1/index.html">Deploy the Bare Metal Node</a></span>
  <span class="next"><a href="../chapter3/index.html">Setup the Hub Cluster</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
