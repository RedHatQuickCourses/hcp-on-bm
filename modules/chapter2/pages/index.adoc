= Prepare the BareMetal Node

1. Familiarize yourself with the HCP on BM architecture.
+
image::s3-fig-1.png[]
+
NOTE: Is there an SVG (or google slides) version of that diagram?

2. Once the instance is up and running, ssh to the node using the private key downloaded earlier. 
+
image::s3-fig-2.jpg[]

3. The public IP of the instance can be obtained from the AWS console after clicking on the instance.
+
[source,subs="verbatim,quotes"]
--
$ ssh -i _<path to the private key>_  ec2-user@_<public ip>_
--

4. Install Ansible Core and other supporting packages.
+
[source,subs="verbatim,quotes"]
--
$ sudo -i
# dnf install ansible-core -y
# ansible-galaxy collection install community.libvirt
# ansible-galaxy collection install community.crypto
--

5. Download latest `rhel-9.5-x86_64-kvm.qcow2` cloud image (*Red Hat Enterprise Linux 9.5 KVM Guest Image*) from the https://access.redhat.com/downloads[customer portal] and copy to the baremetal node.
+
WARNING: Make learners aware of that BEFORE starting. Not good pausing here while it downloads, 10min or more for me.
+
[ Cannot find a way of getting the download URL to use with curl directly on the EC2 instance. ]

6. Clone the git repository and move the RHEL Image to the correct directory.
+
[source,subs="verbatim,quotes"]
--
$ git clone https://github.com/v2pkthakur/hcp-on-bm.git
$ cp rhel-9.5-x86_64-kvm.qcow2 hcp-on-bm/roles/setup-bm-host/files/
--
+
NOTE: Clone or fork the repository as part of the Quick Courses organization?

7. Explore the inventory and variables and update where required.
+
For example, if you got a newer version of RHEL9 Qcow instead of RHEL9.5, please update the `rhel9_kvm_image` variable.
+
[source,subs="verbatim,quotes"]
--
$ vi vars.yaml
...
rhel9_kvm_image: rhel-9.6-x86_64-kvm.qcow2
... 
--

8. Setup Graphical user interface and VNC access.
+
[source,subs="verbatim,quotes"]
--
# dnf groupinstall "Server with GUI"
# useradd vncuser
# su - vncuser
$ vpcpasswd   # set password
Would you like to enter a view-only password (y/n)? n
$ exit
--
+
WARNING: "vpcpasswd" should be "vncpasswd", right? But it's not in the package group. yum offers to install "tigervnc-server-minimal", is that right?

.. Alternatively, install and configure a TigetVNC Server
+
[source,subs="verbatim,quotes"]
--
# dnf groupinstall "Server with GUI"
# dnf install tigervnc-server
# vi /etc/tigervnc/vncserver.users
:99=vncuser 
# systemctl enable vncserver@:99 --now
--

.. Alternatively, install waypipe and use it instead of a VNC viewer


9. Connect to the public ip of the baremetal node on port 5999 using `vncviewer` to get its graphical console. This will be required to access the Openshift console later.

10. Login on the https://console.redhat.com[Red Hat Hybrid Cloud Console] and get your organization ID, which can be obtained by clicking your name on top right.
+
image::s3-fig-3.jpg[]

11. Create an activation key from the cloud console by entering its https://console.redhat.com/insights/connector/activation-keys[Insights pages] and note down the name of the activation key.
+
Use the details from the screenshot to fill the activation key details. Make sure that you name it appropriately.
+
image::s3-fig-4.jpg[]

12. Copy or download your OpenShift pull secret from the cloud console by entering its https://console.redhat.com/openshift/install/pull-secret[OpenShift pages] and keep the pull secret available for later use.
+
image::s3-fig-5.jpg[]

13. Configure `ansible-vault` to store your organization ID, activation keys, and OpenShift pull secret.
+
[source,subs="verbatim,quotes"]
--
$ ansible-vault create vault.yaml
New Vault password:
Confirm New Vault password:
org_id: _XXXX_
activation_key: _YYYYY_
pull_secret: '_ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ_'
--

14. Set up the baremetal node by running the ansible playbook.
+
[source,subs="verbatim,quotes"]
--
$ ansible-playbook -i inventory/hosts setup_bm_host.yaml --ask-vault-pass
--
